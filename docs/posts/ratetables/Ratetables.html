<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-12-16">
<meta name="description" content="Where we build rate tables">

<title>WaitWhat - Ratetables</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">WaitWhat</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Ratetables</h1>
                  <div>
        <div class="description">
          Where we build rate tables
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">GLMs</div>
                <div class="quarto-category">Insurance</div>
                <div class="quarto-category">Pricing</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 16, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<blockquote class="blockquote">
<p>“The motor insurance industry is big. Really big. You just won’t believe how vastly hugely mind-bogglingly big it is. So why is it still using Ratetables for pricing?” - Not Douglas Adams</p>
</blockquote>
<p>Fake Douglas Adams is right. Despite the oceans of premium we collect every year and whatever irresponsible bigwigs like to tell investors about insurers’ use of analytics, we still use ratetables to do most of our pricing. Do not be fooled by our teams of data scientists and espresso-machined-open-plan offices, when it comes down to big-money items like premiums you will have to pry ratetables from our cold dead hands.</p>
<p>When an insurance exec says something like <em>“Our innovative AI-powered solution leverages advanced machine learning algorithms to revolutionize the way we [something something insurance]”</em> what he’s saying is “<strong>We have a chatbot</strong>”. That’s not to say we don’t use machine learning behind the scenes! Despite what insurtechs like to tell VCs about stuffy tradsurers we aren’t actually Luddites who havent evolved beyond dusty scrolls and tea-leaves. But we are exceptionally opinionated and when it comes to tabular modelling, its depressingly difficult to out-perform a well-made ratetable. We know - we’ve tried.</p>
<p>But what <strong>IS</strong> a ratetable? It barely gets any mention when searched online and despite it being used to transact a gazillion monies of premium per year, there really isn’t much material showing you what they are or how to build one. I think this is shame because the flexibility, transparency and ease of implementation should make them the default way to deploy linear-models.</p>
<p>The tldr version, a ratetable is insurance-speak for a collection of VLOOKUPs. They are basically GLMs converted to tables with lookup values per variable level….And thats about it. Its so embarrassingly simple we are too embarrassed to talk about it. If you’ve ever used VLOOKUP in Excel, congratulations you’ve used a ratetable.</p>
<p>Slightly wordier version, ratetables are GLMs that have been converted to a series of mutliplicative lookup tables with each variable in the model rescaled to some reference level providing users more intuitive understanding of the effect each variable has on the target and the intercept of the model adjusted by an offsetting amount to ensure the predictions still tally up.</p>
<section id="examples" class="level3">
<h3 class="anchored" data-anchor-id="examples">Examples</h3>
<p>Imagine we have a GLM with the following formula <span class="math inline">\(y=e^{(0.1x + 0.05)}\)</span> and <span class="math inline">\(x \in [10, 20]\)</span> how would we represent this as a ratetable? Well lets plug values into the formula</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="dv">10</span>,<span class="at">to=</span><span class="dv">20</span>,<span class="at">by=</span><span class="dv">1</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x, \(x) {<span class="fu">exp</span>(<span class="fl">0.1</span><span class="sc">*</span>x)})</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="st">"x"</span> <span class="ot">=</span> x,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>       <span class="st">"y=exp(0.1*x+0.05) "</span> <span class="ot">=</span> <span class="fu">exp</span>(x<span class="sc">*</span><span class="fl">0.1</span> <span class="sc">+</span> <span class="fl">0.05</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>       )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 2
       x `y=exp(0.1*x+0.05) `
   &lt;dbl&gt;                &lt;dbl&gt;
 1    10                 2.86
 2    11                 3.16
 3    12                 3.49
 4    13                 3.86
 5    14                 4.26
 6    15                 4.71
 7    16                 5.21
 8    17                 5.75
 9    18                 6.36
10    19                 7.03
11    20                 7.77</code></pre>
</div>
</div>
<p>As you can see above there is a 1:1 relationship between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> . Congratulations you just made a <em>almost</em>-ratetable.</p>
<p>Now to make it into a ratetable we split out the calculations into the effect of <span class="math inline">\(x\)</span> and the intercept.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="st">"x"</span> <span class="ot">=</span> x,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>       <span class="st">"y=exp(0.1*x+0.05) "</span> <span class="ot">=</span> <span class="fu">exp</span>(x<span class="sc">*</span><span class="fl">0.1</span> <span class="sc">+</span> <span class="fl">0.05</span>),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>       <span class="st">"intercept"</span> <span class="ot">=</span> <span class="fu">exp</span>(<span class="fl">0.05</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">"effect of x"</span> <span class="ot">=</span> <span class="fu">exp</span>(x<span class="sc">*</span><span class="fl">0.1</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>       )  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 4
       x `y=exp(0.1*x+0.05) ` intercept `effect of x`
   &lt;dbl&gt;                &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;
 1    10                 2.86      1.05          2.72
 2    11                 3.16      1.05          3.00
 3    12                 3.49      1.05          3.32
 4    13                 3.86      1.05          3.67
 5    14                 4.26      1.05          4.06
 6    15                 4.71      1.05          4.48
 7    16                 5.21      1.05          4.95
 8    17                 5.75      1.05          5.47
 9    18                 6.36      1.05          6.05
10    19                 7.03      1.05          6.69
11    20                 7.77      1.05          7.39</code></pre>
</div>
</div>
<p>And right here we have a simplest ratetable with one variable and all we had to do was isolate the effect of the sole variable into a lookup table.</p>
<p>Usually ratetables rescale the effect of each variable to be in relation to some reference level i.e.&nbsp;some value we use to say has no effect and we compare other values against this. We like to do this because it makes it more intuitive to discuss the effects of different variables. In our example we would say <span class="math inline">\(x=10\)</span> increases the response approx. 2.7 times and would give the misleading impression that somehow 10 is very ‘risky’ until you realise that every other value of x results in a higher response, so in effect rather than increasing the risk 2.7, relative to the ‘average’ value that x can take on, x=10 is actually less risky and would reduce the risk versus the average.</p>
<p>Lets make an adjustment. Say we know <span class="math inline">\(x=13\)</span> is the most common value of <span class="math inline">\(x\)</span> and choose this as the baseline, so lets divide the effect of variable <span class="math inline">\(x\)</span> by <span class="math inline">\(f(x=13):3.857426\)</span> to create the relativity table for x and adjust the intercept by an offsetting amount.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="st">"x"</span> <span class="ot">=</span> x,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>       <span class="st">"y=exp(0.1*x+0.05) "</span> <span class="ot">=</span> <span class="fu">exp</span>(x<span class="sc">*</span><span class="fl">0.1</span> <span class="sc">+</span> <span class="fl">0.05</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>       <span class="st">"New Intercept"</span> <span class="ot">=</span> <span class="fu">exp</span>(<span class="dv">13</span><span class="sc">*</span><span class="fl">0.1</span> <span class="sc">+</span> <span class="fl">0.05</span>),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Rescaled-x"</span> <span class="ot">=</span> <span class="fu">exp</span>(x<span class="sc">*</span><span class="fl">0.1</span>)<span class="sc">/</span>(<span class="fu">exp</span>(<span class="dv">13</span><span class="sc">*</span><span class="fl">0.1</span>))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>       )  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 4
       x `y=exp(0.1*x+0.05) ` `New Intercept` `Rescaled-x`
   &lt;dbl&gt;                &lt;dbl&gt;           &lt;dbl&gt;        &lt;dbl&gt;
 1    10                 2.86            3.86        0.741
 2    11                 3.16            3.86        0.819
 3    12                 3.49            3.86        0.905
 4    13                 3.86            3.86        1    
 5    14                 4.26            3.86        1.11 
 6    15                 4.71            3.86        1.22 
 7    16                 5.21            3.86        1.35 
 8    17                 5.75            3.86        1.49 
 9    18                 6.36            3.86        1.65 
10    19                 7.03            3.86        1.82 
11    20                 7.77            3.86        2.01 </code></pre>
</div>
</div>
</section>
<section id="section" class="level3">
<h3 class="anchored" data-anchor-id="section"></h3>
<p>What if we have more than 1 variable? Its exactly the same idea. Lets modify the above formula, <span class="math inline">\(y=\exp^{(0.1x - 0.05y + 0.05)}\)</span> with <span class="math inline">\(y= \in [0,5]\)</span> this time choosing <span class="math inline">\(y=3\)</span> as the reference level for <span class="math inline">\(y\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="dv">10</span>,<span class="at">to=</span><span class="dv">20</span>,<span class="at">by=</span><span class="dv">1</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="dv">0</span>, <span class="at">to=</span><span class="dv">5</span>, <span class="at">by=</span><span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="st">"x"</span> <span class="ot">=</span> x,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>       <span class="st">"relativities for x"</span> <span class="ot">=</span> <span class="fu">exp</span>(x<span class="sc">*</span><span class="fl">0.1</span>)<span class="sc">/</span>(<span class="fu">exp</span>(<span class="dv">13</span><span class="sc">*</span><span class="fl">0.1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 2
       x `relativities for x`
   &lt;dbl&gt;                &lt;dbl&gt;
 1    10                0.741
 2    11                0.819
 3    12                0.905
 4    13                1    
 5    14                1.11 
 6    15                1.22 
 7    16                1.35 
 8    17                1.49 
 9    18                1.65 
10    19                1.82 
11    20                2.01 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="st">"y"</span> <span class="ot">=</span> y,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>       <span class="st">"relativities for y"</span> <span class="ot">=</span> <span class="fu">exp</span>(y<span class="sc">*</span>(<span class="sc">-</span><span class="fl">0.05</span>))<span class="sc">/</span>(<span class="fu">exp</span>(<span class="dv">3</span><span class="sc">*</span>(<span class="sc">-</span><span class="fl">0.05</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
      y `relativities for y`
  &lt;dbl&gt;                &lt;dbl&gt;
1     0                1.16 
2     1                1.11 
3     2                1.05 
4     3                1    
5     4                0.951
6     5                0.905</code></pre>
</div>
</div>
<p>As we rescaled both <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> we need to adjust the model’s intercept, so in this case the new baseline would be <span class="math inline">\(e^{13*0.1 + 3*(-0.05) + 0.05}\)</span> in order for the model’s predictions to still give the same predictions.</p>
<p>I wont rant too much about why insurers still use ratetables instead of other tabular-style models or even ‘pure’ GLMS, but my shortlist contenders:</p>
<ul>
<li>Most off-the-shelf systems are built around deploying table-based models and it is a major IT job to migrate away from them.</li>
<li>The interpretability and transparency provided by ratetables cant be matched.</li>
<li>Ease of deployment. Docker? Pffft, try pen and paper. Want to make your model more complex? Use the other side of the page</li>
<li>‘Tweakability’. Do you want to force a certain behavior from your model? Ratetables make this trivial and you can treat them like Lego blocks. This is essential for when you’re launching a new product and you’re data-poor.</li>
</ul>
<p>There are a few tools out there that cast the spells to automatically build and export GLMs as ratetables but all these tools are expensive and require talking to sales representatives.</p>
<p>And since my wife is busy getting her hair done and we have about 2 hours to kill in this Starbucks we’re going to make our own ratetables</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Bender.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">’Cos I’m a mature professional</figcaption>
</figure>
</div>
</section>
<section id="building-a-ratetable" class="level2">
<h2 class="anchored" data-anchor-id="building-a-ratetable">Building a ratetable</h2>
<ul>
<li><p>If you’re a Data Scientist you’d probably call this ‘<em>Individual Conditional Expectations</em>’ (<strong><em>ICE</em></strong> )</p></li>
<li><p>If you’re the rubber-ducky on my desk you know this as ’<em>Take a random line of data, duplicate it a bunch of times and change the values of just the variable you care about and see how the predictions changed</em></p></li>
</ul>
<p>Its quite rate that you’ll have a nice and simple GLM of the form I used above with ‘clean’ coefficients. Its much more likely you’ll have splines or polynomials used on some of the numeric variables, so the direct approach of converting the coefficients into tables wont work. Instead this method works for any GLM/GAM provided there aren’t any interactions (the second method works better for this).</p>
<p>We are going to use the <strong><em>insuraceData</em></strong> package, load up the <strong><em>AutoClaims</em></strong> dataset and then build a simple GLM for claim severity. We don’t care that the model itself I just want to focus on the actual ratetabley bits.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(insuranceData)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv) <span class="co"># fit gam</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(AutoClaims)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># fit numeric variables as GAMs to avoid having to</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>claims_glm <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(PAID <span class="sc">~</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">s</span>(<span class="fu">pmin</span>(AGE,<span class="dv">95</span>),<span class="at">k=</span><span class="dv">3</span>, <span class="at">bs=</span><span class="st">"cr"</span>) <span class="sc">+</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                    GENDER <span class="sc">+</span> </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                    CLASS <span class="sc">+</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                    STATE,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> AutoClaims,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="st">"log"</span>))</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># model output</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(claims_glm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: Gamma 
Link function: log 

Formula:
PAID ~ s(pmin(AGE, 95), k = 3, bs = "cr") + GENDER + CLASS + 
    STATE

Parametric coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)    7.372967   0.121985  60.441  &lt; 2e-16 ***
GENDERM       -0.008085   0.035549  -0.227  0.82009    
CLASSC11      -0.001279   0.068666  -0.019  0.98513    
CLASSC1A      -0.052953   0.169438  -0.313  0.75465    
CLASSC1B       0.032155   0.087917   0.366  0.71457    
CLASSC1C      -0.214266   0.235316  -0.911  0.36257    
CLASSC2       -0.318220   0.188683  -1.687  0.09174 .  
CLASSC6       -0.018006   0.078295  -0.230  0.81811    
CLASSC7        0.002340   0.072101   0.032  0.97411    
CLASSC71       0.016351   0.070098   0.233  0.81557    
CLASSC72       0.225273   0.163104   1.381  0.16728    
CLASSC7A       0.055853   0.143855   0.388  0.69783    
CLASSC7B       0.166986   0.078150   2.137  0.03265 *  
CLASSC7C       0.195217   0.166980   1.169  0.24240    
CLASSF1       -0.078495   0.267407  -0.294  0.76912    
CLASSF11       0.116224   0.230421   0.504  0.61400    
CLASSF6       -0.006399   0.130963  -0.049  0.96103    
CLASSF7       -0.495043   0.192008  -2.578  0.00995 ** 
CLASSF71      -0.059815   0.157060  -0.381  0.70333    
STATESTATE 02  0.108242   0.117960   0.918  0.35885    
STATESTATE 03  0.118306   0.133515   0.886  0.37560    
STATESTATE 04  0.059744   0.123815   0.483  0.62945    
STATESTATE 06  0.263534   0.124330   2.120  0.03407 *  
STATESTATE 07  0.181269   0.140526   1.290  0.19712    
STATESTATE 10  0.157797   0.139320   1.133  0.25741    
STATESTATE 11  0.097603   0.483004   0.202  0.83986    
STATESTATE 12  0.393129   0.143128   2.747  0.00604 ** 
STATESTATE 13  0.225654   0.147946   1.525  0.12725    
STATESTATE 14  0.050829   0.154268   0.329  0.74180    
STATESTATE 15  0.083418   0.114447   0.729  0.46610    
STATESTATE 17  0.210776   0.128050   1.646  0.09980 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                   edf Ref.df     F p-value  
s(pmin(AGE, 95)) 1.923  1.994 3.757  0.0197 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.0036   Deviance explained = 1.46%
GCV = 1.1323  Scale est. = 1.9841    n = 6773</code></pre>
</div>
</div>
<p>Now we build a function that can take in the model, the dataset, the variable we want to build the relativity table for and a set of values we want to test it on using the rubber-ducky approach</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>make_rate_table <span class="ot">&lt;-</span> <span class="cf">function</span>(model,dataset,variable, variable_values){</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  dataset <span class="ot">&lt;-</span> <span class="fu">setDT</span>(dataset) <span class="co"># convert to data.table</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  base_prediction <span class="ot">&lt;-</span> dataset[<span class="fu">sample</span>(.N, <span class="dv">1</span>)] <span class="co">#sample a single line from the dataset</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  col_nr <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(dataset)<span class="sc">==</span>variable) <span class="co"># find the column number for the variable</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  base_prediction<span class="sc">$</span>rep <span class="ot">&lt;-</span> <span class="fu">length</span>(variable_values) <span class="co">#new column that tells us how many lines of data we need to duplicate our sample</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  expd <span class="ot">&lt;-</span> splitstackshape<span class="sc">::</span><span class="fu">expandRows</span>(base_prediction, <span class="st">"rep"</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  expd[,col_nr] <span class="ot">&lt;-</span> variable_values <span class="co"># replace the variable with the values provided</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predictions &lt;- predict.glm(model, newdata = expd, type= "response")</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">predict.gam</span>(model, <span class="at">newdata =</span> expd, <span class="at">type=</span> <span class="st">"response"</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale the predictions relative to the lowest value so we get relativities</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">Level =</span> variable_values,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Relativity =</span> predictions<span class="sc">/</span><span class="fu">min</span>(predictions)))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can apply this function to create the rate table for the Driver Age variable</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the table of relativities</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>age_relativities <span class="ot">&lt;-</span> <span class="fu">make_rate_table</span>(claims_glm,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">dataset =</span> AutoClaims,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">variable =</span> <span class="st">"AGE"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">variable_values =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(AutoClaims<span class="sc">$</span>AGE)))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># lets look at the table</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(age_relativities[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">Level</th>
<th style="text-align: right;">Relativity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">50</td>
<td style="text-align: right;">1.059501</td>
</tr>
<tr class="even">
<td style="text-align: right;">51</td>
<td style="text-align: right;">1.053348</td>
</tr>
<tr class="odd">
<td style="text-align: right;">52</td>
<td style="text-align: right;">1.047287</td>
</tr>
<tr class="even">
<td style="text-align: right;">53</td>
<td style="text-align: right;">1.041370</td>
</tr>
<tr class="odd">
<td style="text-align: right;">54</td>
<td style="text-align: right;">1.035650</td>
</tr>
<tr class="even">
<td style="text-align: right;">55</td>
<td style="text-align: right;">1.030180</td>
</tr>
<tr class="odd">
<td style="text-align: right;">56</td>
<td style="text-align: right;">1.025009</td>
</tr>
<tr class="even">
<td style="text-align: right;">57</td>
<td style="text-align: right;">1.020187</td>
</tr>
<tr class="odd">
<td style="text-align: right;">58</td>
<td style="text-align: right;">1.015762</td>
</tr>
<tr class="even">
<td style="text-align: right;">59</td>
<td style="text-align: right;">1.011785</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot these</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(age_relativities,<span class="fu">aes</span>(<span class="at">x=</span>Level,<span class="at">y=</span>Relativity))<span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Driver Age Relativities"</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="st">"Very weird shape!"</span>)<span class="sc">+</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ratetables_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We’ve created our first table for the driver age. We now need to do this for all the other variables using the same idea.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># List of variables</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"GENDER"</span>, <span class="st">"CLASS"</span>, <span class="st">"STATE"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an empty list to store the relativity tables</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>relativities <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop to create relativity tables</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> variables) {</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  relativities[[var]] <span class="ot">&lt;-</span> <span class="fu">make_rate_table</span>(claims_glm,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">dataset =</span> AutoClaims,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">variable =</span> var,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">variable_values =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(AutoClaims[[var]])))</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an empty list for plots</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop to create ggplot objects for each relativity</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> <span class="fu">names</span>(relativities)) {</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  plots[[var]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(relativities[[var]], <span class="fu">aes</span>(<span class="at">x=</span>Level, <span class="at">y=</span>Relativity)) <span class="sc">+</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(var, <span class="st">"Relativities"</span>))</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop to display plots</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (plot_name <span class="cf">in</span> <span class="fu">names</span>(plots)) {</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plots[[plot_name]])</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ratetables_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="Ratetables_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="Ratetables_files/figure-html/unnamed-chunk-8-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting (example for one plot, you can loop or selectively plot as needed)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="rebasing" class="level3">
<h3 class="anchored" data-anchor-id="rebasing">Rebasing</h3>
<p>Ok now you’ll see the first downside to this approach is we need to adjust the intercept of the model to make the predictions tally up to the original GLM. To make predictions with this model we will left-join the original dataset to the relativities and calculate the new intercept required to make the predictions line up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to join the main dataset to the relativity tables</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>Tally <span class="ot">&lt;-</span> AutoClaims <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(relativities[[<span class="st">'GENDER'</span>]] <span class="sc">|&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(Level, <span class="at">Relativity_1 =</span> Relativity),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"GENDER"</span> <span class="ot">=</span> <span class="st">"Level"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(relativities[[<span class="st">'CLASS'</span>]] <span class="sc">|&gt;</span> <span class="fu">select</span>(Level, <span class="at">Relativity_2 =</span> Relativity),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"CLASS"</span> <span class="ot">=</span> <span class="st">"Level"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(relativities[[<span class="st">'STATE'</span>]] <span class="sc">|&gt;</span> <span class="fu">select</span>(Level, <span class="at">Relativity_3 =</span> Relativity),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"STATE"</span> <span class="ot">=</span> <span class="st">"Level"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(age_relativities <span class="sc">|&gt;</span> <span class="fu">select</span>(Level, <span class="at">Relativity_4 =</span> Relativity),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"AGE"</span> <span class="ot">=</span> <span class="st">"Level"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AllRelativities =</span> matrixStats<span class="sc">::</span><span class="fu">rowProds</span>(<span class="fu">as.matrix</span>(<span class="fu">across</span>(</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matches</span>(<span class="st">"Relativity_[0-9]"</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  )))) <span class="sc">|&gt;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">BaseRate =</span> <span class="fu">mean</span>(AutoClaims<span class="sc">$</span>PAID)) <span class="sc">|&gt;</span> <span class="co"># set the baserate = avg claim size as starting point</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RateTablePredictions =</span> AllRelativities <span class="sc">*</span> BaseRate) <span class="sc">|&gt;</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GLM_Prediction =</span> <span class="fu">predict</span>(claims_glm, AutoClaims, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Tally)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      STATE CLASS GENDER AGE    PAID Relativity_1 Relativity_2 Relativity_3
1: STATE 14   C6       M  97 1134.44     1.000000     1.611293     1.052143
2: STATE 15   C6       M  96 3761.24     1.000000     1.611293     1.086996
3: STATE 15   C11      M  95 7842.31     1.000000     1.638471     1.086996
4: STATE 15   F6       F  95 2384.67     1.008118     1.630104     1.086996
5: STATE 15   F6       M  95  650.00     1.000000     1.630104     1.086996
6: STATE 15   F6       M  95  391.12     1.000000     1.630104     1.086996
   Relativity_4 AllRelativities BaseRate RateTablePredictions GLM_Prediction
1:      1.48686        2.520691 1853.035             4670.927       2322.296
2:      1.48686        2.604190 1853.035             4825.654       2399.223
3:      1.48686        2.648116 1853.035             4907.050       2439.691
4:      1.48686        2.655980 1853.035             4921.622       2446.937
5:      1.48686        2.634592 1853.035             4881.990       2427.232
6:      1.48686        2.634592 1853.035             4881.990       2427.232</code></pre>
</div>
</div>
<p>Thankfully its quite easy to this as all we need to do is adjust the intercept/baserate of the model such that it still gives the same average response as the original GLM. Lets show what this looks like when plotting the actual vs expected values for the AGE variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lets plot the predictions against the GLM versus the AGE variable</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a> Tally <span class="sc">|&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(AGE) <span class="sc">|&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">Actual =</span> <span class="fu">mean</span>(PAID),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">GLM =</span> <span class="fu">mean</span>(GLM_Prediction),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">RateTable =</span> <span class="fu">mean</span>(RateTablePredictions),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">RateTable_Rebased =</span> <span class="fu">mean</span>(RateTablePredictions<span class="sc">*</span>(<span class="fu">mean</span>(Tally<span class="sc">$</span>GLM)<span class="sc">/</span>(<span class="fu">mean</span>(Tally<span class="sc">$</span>RateTablePredictions))))) <span class="sc">|&gt;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>AGE,<span class="at">y=</span>Actual,<span class="at">group=</span><span class="dv">1</span>,<span class="at">colour=</span><span class="st">"Actual"</span>))<span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>AGE,<span class="at">y=</span>GLM,<span class="at">group=</span><span class="dv">1</span>,<span class="at">colour=</span><span class="st">"GLM"</span>))<span class="sc">+</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>AGE,<span class="at">y=</span>RateTable,<span class="at">group=</span><span class="dv">1</span>,<span class="at">colour=</span><span class="st">"RateTable"</span>))<span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>AGE,<span class="at">y=</span>RateTable_Rebased,<span class="at">group=</span><span class="dv">1</span>,<span class="at">colour=</span><span class="st">"RateTable_Rebased"</span>),<span class="at">size=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggtitle</span>(<span class="st">"Actual vs Predicted Comparison for AGE"</span>, <span class="at">subtitle =</span> <span class="st">"Rebasing makes it align perfectly with the original GLM"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ratetables_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As you can see the predictions from the ratetables line up exactly with the original model once we rebase the predictions. However while rebasing is not difficult it is tedious, especially when you have dozens of variables to work through.</p>
</section>
<section id="interactions" class="level3">
<h3 class="anchored" data-anchor-id="interactions">Interactions</h3>
<p>The second thing to be aware of with this approach is it can give misleading relativities when you’re trying to isolate the effect of interactions. This is because <strong><em>ICE</em></strong> will vary all aspects of the model that contain the variable of interest <strong>including the</strong> <strong>interactions</strong>, so for example say we had <em>AGE</em> interacted with <em>STATE,</em> when varying the <em>AGE</em> variable to create its ratetable, we will also be picking up the effect of <em>AGE</em>:<em>STATE</em>. This is a pain to work reverse out and my suggestion when using <strong><em>ICE</em></strong> is to make duplicates for all variables you want to interact in order to isolate their effects.</p>
<p>Again this is best shown with an example. Lets interact <em>AGE</em> and <em>STATE</em> and illustrate the differences in relativities caused by interactions when blindly applying the <strong><em>ICE</em></strong> approach:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># new model interacting AGE &amp; CLASS</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>claims_glm_interactions <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(PAID <span class="sc">~</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">s</span>(<span class="fu">pmin</span>(AGE,<span class="dv">95</span>),<span class="at">k=</span><span class="dv">3</span>, <span class="at">bs=</span><span class="st">"cr"</span>) <span class="sc">+</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                    CLASS <span class="sc">+</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                    STATE <span class="sc">+</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                    GENDER <span class="sc">+</span> </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                    AGE<span class="sc">:</span>STATE,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> AutoClaims,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="st">"log"</span>))</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># duplicate AGE and CLASS and build new GLM off the duplicated columns</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>AutoClaims<span class="sc">$</span>AGE_2 <span class="ot">&lt;-</span> AutoClaims<span class="sc">$</span>AGE</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>AutoClaims<span class="sc">$</span>STATE_2 <span class="ot">&lt;-</span> AutoClaims<span class="sc">$</span>STATE</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>claims_glm_interactions2 <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(PAID <span class="sc">~</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">s</span>(<span class="fu">pmin</span>(AGE,<span class="dv">95</span>),<span class="at">k=</span><span class="dv">3</span>, <span class="at">bs=</span><span class="st">"cr"</span>) <span class="sc">+</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>                    CLASS <span class="sc">+</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                    STATE <span class="sc">+</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>                    GENDER <span class="sc">+</span> </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>                    AGE_2<span class="sc">:</span>STATE_2,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> AutoClaims,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="st">"log"</span>))</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="co"># ICE function for two variables</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>make_rate_table_2var <span class="ot">&lt;-</span> <span class="cf">function</span>(model,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>                                 dataset,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>                                 variable1,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>                                 variable2, </span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>                                 variable1_values,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>                                 variable2_values</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>                                 ){</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  dataset <span class="ot">&lt;-</span> <span class="fu">setDT</span>(dataset) <span class="co"># convert to data.table</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  base_prediction <span class="ot">&lt;-</span> dataset[<span class="fu">sample</span>(.N, <span class="dv">1</span>)] <span class="co">#sample a single line from the dataset</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  baseline <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(mgcv<span class="sc">::</span><span class="fu">predict.gam</span>(model, <span class="at">newdata =</span> base_prediction, <span class="at">type=</span> <span class="st">"response"</span>))</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>  col_nr1 <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(dataset)<span class="sc">==</span>variable1) <span class="co"># find the column number for the 1st variable</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  col_nr2 <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(dataset)<span class="sc">==</span>variable2) <span class="co"># find the column number for the 2nd variable</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create every unique combination of the var1 and var2</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  uniq_comb <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(variable1_values,variable2_values)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(uniq_comb) <span class="ot">&lt;-</span> <span class="fu">c</span>(variable1,variable2)</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>  base_prediction<span class="sc">$</span>rep <span class="ot">&lt;-</span> <span class="fu">nrow</span>(uniq_comb) <span class="co">#new column that tells us how many lines of data we need to duplicate our sample</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>  expd <span class="ot">&lt;-</span> splitstackshape<span class="sc">::</span><span class="fu">expandRows</span>(base_prediction, <span class="st">"rep"</span>)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>  expd[,col_nr1] <span class="ot">&lt;-</span> uniq_comb[,<span class="dv">1</span>] <span class="co"># replace the variable with the values provided</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  expd[,col_nr2] <span class="ot">&lt;-</span> uniq_comb[,<span class="dv">2</span>] <span class="co"># replace the variable with the values provided</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predictions &lt;- predict.glm(model, newdata = expd, type= "response")</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">predict.gam</span>(model, <span class="at">newdata =</span> expd, <span class="at">type=</span> <span class="st">"response"</span>)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>  expd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(expd)</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>  final_frame <span class="ot">=</span> <span class="fu">data.frame</span>(expd[,col_nr1],</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>                    expd[,col_nr2],</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Relativity =</span> predictions<span class="sc">/</span>(baseline))</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(final_frame) <span class="ot">&lt;-</span> <span class="fu">c</span>(variable1,variable2,<span class="st">"Relativity"</span>)</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale the predictions relative to the lowest value so we get relativities</span></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final_frame)</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">make_rate_table_2var</span>(claims_glm_interactions,</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>                                 AutoClaims,</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"AGE"</span>,</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"STATE"</span>, </span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>                                <span class="at">variable1_values =</span>  <span class="fu">sort</span>(<span class="fu">unique</span>(AutoClaims<span class="sc">$</span>AGE)),</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>                                <span class="at">variable2_values =</span>  <span class="fu">sort</span>(<span class="fu">unique</span>(AutoClaims<span class="sc">$</span>STATE))</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>                                 ) <span class="sc">%&gt;%</span> </span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AGE,<span class="at">y=</span>Relativity,<span class="at">group=</span>STATE, <span class="at">colour=</span>STATE))<span class="sc">+</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"AGE:STATE Incorrect"</span>, <span class="at">subtitle =</span> <span class="st">"Lies, deception"</span>)</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">make_rate_table_2var</span>(claims_glm_interactions2,</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>                                 AutoClaims,</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"AGE_2"</span>,</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"STATE_2"</span>, </span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>                                <span class="at">variable1_values =</span>  <span class="fu">sort</span>(<span class="fu">unique</span>(AutoClaims<span class="sc">$</span>AGE_2)),</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>                                <span class="at">variable2_values =</span>  <span class="fu">sort</span>(<span class="fu">unique</span>(AutoClaims<span class="sc">$</span>STATE_2))</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>                                 ) <span class="sc">%&gt;%</span> </span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AGE_2,<span class="at">y=</span>Relativity,<span class="at">group=</span>STATE_2, <span class="at">colour=</span>STATE_2))<span class="sc">+</span></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"AGE:STATE Correct"</span>, <span class="at">subtitle =</span> <span class="st">"The other thing"</span>)</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(p1, p2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ratetables_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As you can see above, the two graphs show totally different relativities for what should be the same thing, however this is simply because in the first approach we are picking up the effect of the interactions and the individual effects of <em>AGE</em> and <em>STATE.</em> The second graph is the true interaction effect and is what would be used in your ratetable.</p>
<p>There is another method I use to build ratetables to try and get around the rebasing and interaction issues which I will write about in future. This second method is a lot more ‘fiddly’ and needs adjusting to different modelling packages but does involve the use of the word <em>matrix</em> which immediately gives us extra LinkedIn-points.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>